{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card theme-card">
                <div class="card-header theme-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 theme-text">Excel'den Oracle'a Veri Aktarımı</h4>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal"
                                data-bs-target="#savedProcessesModal">
                                <i class="fas fa-folder-open"></i> Kayıtlı İşlemler
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" id="saveCurrentProcess">
                                <i class="fas fa-save"></i> Bu İşlemi Kaydet
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body theme-body">
                    <form id="excelImportForm" enctype="multipart/form-data" novalidate>
                        <!-- Dosya Seçimi -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="step-number me-3">1</div>
                                <h5 class="mb-0 theme-text">Dosya Seçimi</h5>
                            </div>
                            <div class="ps-5">
                                <div class="d-flex gap-4 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="fileInputMode"
                                            id="fileSelectMode" value="select" checked>
                                        <label class="form-check-label theme-text" for="fileSelectMode">Dosya
                                            Seç</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="fileInputMode"
                                            id="filePathMode" value="path">
                                        <label class="form-check-label theme-text" for="filePathMode">Dosya Yolu
                                            Gir</label>
                                    </div>
                                </div>

                                <div id="fileSelectSection">
                                    <input type="file" class="form-control theme-input" id="excelFile"
                                        accept=".xlsx,.xls">
                                </div>

                                <div id="filePathSection" class="mt-2" style="display: none;">
                                    <input type="text" class="form-control theme-input" id="excelFilePath"
                                        placeholder="Excel dosyasının tam yolunu girin">
                                </div>

                                <div class="mt-3">
                                    <label for="sheetSelect" class="form-label theme-text">Excel Sayfası</label>
                                    <select class="form-select theme-input" id="sheetSelect" disabled>
                                        <option value="">Önce Excel dosyası seçin</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tablo Seçimi -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="step-number me-3">2</div>
                                <h5 class="mb-0 theme-text">Tablo Seçimi</h5>
                            </div>
                            <div class="ps-5">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="createNewTable">
                                    <label class="form-check-label theme-text" for="createNewTable">Yeni Tablo
                                        Oluştur</label>
                                </div>

                                <div id="existingTableSection">
                                    <label for="tableSelect" class="form-label theme-text">Hedef Oracle Tablosu</label>
                                    <select class="form-select theme-input mb-3" id="tableSelect">
                                        <option value="">Yükleniyor...</option>
                                    </select>

                                    <div class="card theme-subcard">
                                        <div class="card-body">
                                            <label class="form-label theme-text">İçe Aktarma Modu</label>
                                            <div class="d-flex gap-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="importMode"
                                                        id="appendMode" value="append" checked>
                                                    <label class="form-check-label theme-text" for="appendMode">Mevcut
                                                        verilere ekle</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="importMode"
                                                        id="replaceMode" value="replace">
                                                    <label class="form-check-label theme-text" for="replaceMode">Mevcut
                                                        verileri değiştir</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="newTableSection" style="display: none;">
                                    <label for="newTableName" class="form-label theme-text">Yeni Tablo Adı</label>
                                    <input type="text" class="form-control theme-input" id="newTableName"
                                        placeholder="Yeni tablo adını girin">
                                    <div class="form-text theme-text-secondary">Tablo adı sadece harf, rakam ve alt
                                        çizgi içerebilir.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Sütun Eşleştirme -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="step-number me-3">3</div>
                                <h5 class="mb-0 theme-text">Sütun Eşleştirme</h5>
                            </div>
                            <div class="ps-5">
                                <div class="table-responsive">
                                    <table class="table table-sm theme-table">
                                        <thead>
                                            <tr id="columnMappingHeader"></tr>
                                        </thead>
                                        <tbody id="columnMappingBody"></tbody>
                                    </table>
                                </div>
                                <div class="alert theme-alert mt-3">
                                    <small><i class="fas fa-info-circle"></i> Excel sütun isimleri otomatik olarak
                                        Oracle
                                        uyumlu formata dönüştürülür.</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-danger" id="errorAlert" style="display: none;"></div>
                        <div class="alert alert-success" id="successAlert" style="display: none;"></div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-file-import"></i> İçe Aktarmayı Başlat
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kayıtlı İşlemler Modal -->
<div class="modal fade" id="savedProcessesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content theme-modal">
            <div class="modal-header theme-border">
                <h5 class="modal-title theme-text">Kayıtlı İşlemler</h5>
                <button type="button" class="btn-close theme-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover theme-table">
                        <thead>
                            <tr>
                                <th>İşlem Adı</th>
                                <th>Dosya Yolu</th>
                                <th>Hedef Tablo</th>
                                <th>Son Kullanım</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="savedProcessesList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İşlem Kaydetme Modal -->
<div class="modal fade" id="saveProcessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content theme-modal">
            <div class="modal-header theme-border">
                <h5 class="modal-title theme-text">İşlemi Kaydet</h5>
                <button type="button" class="btn-close theme-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="processName" class="form-label theme-text">İşlem Adı</label>
                    <input type="text" class="form-control theme-input" id="processName"
                        placeholder="İşlem için bir isim girin">
                </div>
            </div>
            <div class="modal-footer theme-border">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveProcessButton">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Tema Değişkenleri */
    :root {
        /* Light tema */
        --light-bg: #ffffff;
        --light-card-bg: #ffffff;
        --light-header-bg: #ffffff;
        --light-text: #212529;
        --light-text-secondary: #6c757d;
        --light-border: #dee2e6;
        --light-input-bg: #ffffff;
        --light-input-border: #ced4da;
        --light-table-bg: #ffffff;
        --light-table-border: #dee2e6;
        --light-alert-bg: #e7f5ff;
        --light-alert-text: #0c5460;
        --light-step-bg: #e9ecef;
        --light-step-text: #495057;
        --light-shadow: rgba(0, 0, 0, 0.05);
    }

    [data-bs-theme="dark"] {
        /* Dark tema */
        --light-bg: #212529;
        --light-card-bg: #212529;
        --light-header-bg: #212529;
        --light-text: #ffffff;
        --light-text-secondary: #adb5bd;
        --light-border: #495057;
        --light-input-bg: #2c3034;
        --light-input-border: #495057;
        --light-table-bg: #2c3034;
        --light-table-border: #495057;
        --light-alert-bg: #343a40;
        --light-alert-text: #adb5bd;
        --light-step-bg: #343a40;
        --light-step-text: #adb5bd;
        --light-shadow: rgba(0, 0, 0, 0.2);
    }

    /* Tema Sınıfları */
    .theme-card {
        border: none;
        box-shadow: 0 0 20px var(--light-shadow);
        border-radius: 10px;
        background-color: var(--light-card-bg);
    }

    .theme-header {
        background-color: var(--light-header-bg);
        border-bottom: 1px solid var(--light-border);
    }

    .theme-body {
        background-color: var(--light-card-bg);
    }

    .theme-text {
        color: var(--light-text);
    }

    .theme-text-secondary {
        color: var(--light-text-secondary);
    }

    .theme-border {
        border-color: var(--light-border);
    }

    .theme-input {
        background-color: var(--light-input-bg);
        border-color: var(--light-input-border);
        color: var(--light-text);
    }

    .theme-input:focus {
        background-color: var(--light-input-bg);
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
    }

    .theme-input::placeholder {
        color: var(--light-text-secondary);
    }

    .theme-table {
        background-color: var(--light-table-bg);
        color: var(--light-text);
    }

    .theme-table th {
        background-color: var(--light-header-bg);
        border-color: var(--light-table-border);
    }

    .theme-table td {
        border-color: var(--light-table-border);
    }

    .theme-alert {
        background-color: var(--light-alert-bg);
        color: var(--light-alert-text);
        border: none;
        border-radius: 6px;
    }

    .theme-modal {
        background-color: var(--light-card-bg);
        border-color: var(--light-border);
    }

    .theme-close {
        filter: var(--light-text) brightness(0) invert(1);
    }

    .theme-subcard {
        background-color: var(--light-header-bg);
        border-color: var(--light-border);
    }

    .step-number {
        width: 32px;
        height: 32px;
        background-color: var(--light-step-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--light-step-text);
    }

    .form-label {
        font-weight: 500;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        font-weight: 500;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Form elemanları
        const form = document.getElementById('excelImportForm');
        const fileInput = document.getElementById('excelFile');
        const filePathInput = document.getElementById('excelFilePath');
        const sheetSelect = document.getElementById('sheetSelect');
        const tableSelect = document.getElementById('tableSelect');
        const createNewTableCheckbox = document.getElementById('createNewTable');
        const existingTableSection = document.getElementById('existingTableSection');
        const newTableSection = document.getElementById('newTableSection');
        const newTableNameInput = document.getElementById('newTableName');
        const columnMappingBody = document.getElementById('columnMappingBody');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');

        let excelColumns = [];
        let oracleColumns = [];
        let columnTypes = {};

        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            successAlert.style.display = 'none';
        }

        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            errorAlert.style.display = 'none';
        }

        // Dosya seçim modu değişikliği
        document.querySelectorAll('input[name="fileInputMode"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const fileSelectSection = document.getElementById('fileSelectSection');
                const filePathSection = document.getElementById('filePathSection');

                if (this.value === 'select') {
                    fileSelectSection.style.display = 'block';
                    filePathSection.style.display = 'none';
                } else {
                    fileSelectSection.style.display = 'none';
                    filePathSection.style.display = 'block';
                }
            });
        });

        // Yeni/Mevcut tablo seçimi
        createNewTableCheckbox.addEventListener('change', function () {
            existingTableSection.style.display = this.checked ? 'none' : 'block';
            newTableSection.style.display = this.checked ? 'block' : 'none';
        });

        // Excel dosyası seçildiğinde veya dosya yolu girildiğinde
        function handleFileInput() {
            const fileInputMode = document.querySelector('input[name="fileInputMode"]:checked').value;
            const formData = new FormData();

            if (fileInputMode === 'select' && fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
                formData.append('file_input_mode', 'select');
            } else if (fileInputMode === 'path') {
                const filePath = filePathInput.value.trim();
                if (filePath) {
                    formData.append('file_path', filePath);
                    formData.append('file_input_mode', 'path');
                } else {
                    return;
                }
            } else {
                return;
            }

            fetch('/api/excel/sheets', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sheetSelect.innerHTML = '<option value="">Sayfa seçin</option>' +
                            data.sheets.map(sheet => `<option value="${sheet}">${sheet}</option>`).join('');
                        sheetSelect.disabled = false;
                    } else {
                        showError('Sayfalar yüklenirken hata oluştu: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Sayfalar yüklenirken hata oluştu: ' + error);
                });
        }

        // Excel sayfası seçildiğinde sütun bilgilerini al
        function loadSheetColumns() {
            const fileInputMode = document.querySelector('input[name="fileInputMode"]:checked').value;
            const formData = new FormData();

            if (fileInputMode === 'select' && fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
                formData.append('file_input_mode', 'select');
            } else if (fileInputMode === 'path') {
                const filePath = filePathInput.value.trim();
                if (filePath) {
                    formData.append('file_path', filePath);
                    formData.append('file_input_mode', 'path');
                } else {
                    return;
                }
            }

            formData.append('sheet_name', sheetSelect.value);

            fetch('/api/excel/columns', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        excelColumns = data.columns;
                        columnTypes = data.column_types;
                        if (!createNewTableCheckbox.checked && tableSelect.value) {
                            updateColumnMapping();
                        }
                    } else {
                        showError('Sütun bilgileri alınırken hata oluştu: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Sütun bilgileri alınırken hata oluştu: ' + error);
                });
        }

        // Oracle tablolarını yükle
        function loadOracleTables() {
            fetch('/api/oracle/tables')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tableSelect.innerHTML = '<option value="">Tablo seçin</option>' +
                            data.tables.map(table => `<option value="${table}">${table}</option>`).join('');
                    } else {
                        showError('Tablolar yüklenirken hata oluştu: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Tablolar yüklenirken hata oluştu: ' + error);
                });
        }

        // Oracle sütunlarını yükle
        function loadOracleColumns(tableName) {
            fetch(`/api/oracle/columns/${tableName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        oracleColumns = data.columns;
                        if (excelColumns.length > 0) {
                            updateColumnMapping();
                        }
                    } else {
                        showError('Oracle sütun bilgileri alınırken hata oluştu: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Oracle sütun bilgileri alınırken hata oluştu: ' + error);
                });
        }

        // Sütun eşleştirme arayüzünü güncelle
        function updateColumnMapping() {
            const columnMappingBody = document.getElementById('columnMappingBody');
            columnMappingBody.innerHTML = '';

            excelColumns.forEach(excelCol => {
                const row = document.createElement('tr');

                // Excel sütunu
                const excelCell = document.createElement('td');
                excelCell.textContent = excelCol;
                row.appendChild(excelCell);

                // Oracle sütunu
                const oracleCell = document.createElement('td');
                if (createNewTableCheckbox.checked) {
                    oracleCell.textContent = convertToOracleColumnName(excelCol);
                } else {
                    const select = document.createElement('select');
                    select.className = 'form-select form-select-sm';
                    select.innerHTML = '<option value="">Sütun seçin</option>' +
                        oracleColumns.map(col => `<option value="${col.name}">${col.name}</option>`).join('');
                    // Otomatik eşleştirme: Excel ve Oracle sütun isimleri aynıysa seçili yap
                    const matchIndex = oracleColumns.findIndex(col => col.name === excelCol);
                    if (matchIndex !== -1) {
                        select.selectedIndex = matchIndex + 1; // +1 çünkü ilk option boş
                    }
                    oracleCell.appendChild(select);
                }
                row.appendChild(oracleCell);

                // Veri tipi
                const typeCell = document.createElement('td');
                const typeSelect = document.createElement('select');
                typeSelect.className = 'form-select form-select-sm';
                typeSelect.innerHTML = getDataTypeOptions();

                // Varsayılan veri tipini seç
                const dataType = columnTypes[excelCol]?.toLowerCase() || '';
                if (dataType.includes('int') || dataType.includes('float')) {
                    typeSelect.value = 'NUMBER';
                } else if (dataType.includes('date')) {
                    typeSelect.value = 'DATE';
                } else {
                    typeSelect.value = 'NVARCHAR2(255)';
                }

                typeCell.appendChild(typeSelect);
                row.appendChild(typeCell);

                columnMappingBody.appendChild(row);
            });
        }

        // Veri tipi seçeneklerini oluştur
        function getDataTypeOptions() {
            return `
                <option value="NUMBER">NUMBER</option>
                <option value="INTEGER">INTEGER</option>
                <option value="FLOAT">FLOAT</option>
                <option value="NVARCHAR2(255)">NVARCHAR2(255)</option>
                <option value="NVARCHAR2(1000)">NVARCHAR2(1000)</option>
                <option value="DATE">DATE</option>
                <option value="TIMESTAMP">TIMESTAMP</option>
            `;
        }

        // Excel sütun adını Oracle formatına dönüştür
        function convertToOracleColumnName(name) {
            const trChars = {
                'ı': 'I', 'ğ': 'G', 'ü': 'U', 'ş': 'S', 'ö': 'O', 'ç': 'C',
                'İ': 'I', 'Ğ': 'G', 'Ü': 'U', 'Ş': 'S', 'Ö': 'O', 'Ç': 'C'
            };

            let column = String(name);

            // Türkçe karakterleri değiştir
            Object.entries(trChars).forEach(([tr, en]) => {
                column = column.replace(new RegExp(tr, 'g'), en);
            });

            // Özel karakterleri temizle
            column = column.replace(/[^a-zA-Z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '')
                .toUpperCase();

            // Sayı ile başlıyorsa prefix ekle
            if (/^\d/.test(column)) {
                column = 'COL_' + column;
            }

            return column;
        }

        // Event Listeners
        fileInput.addEventListener('change', handleFileInput);
        filePathInput.addEventListener('input', handleFileInput);
        sheetSelect.addEventListener('change', loadSheetColumns);
        tableSelect.addEventListener('change', function () {
            if (this.value) {
                loadOracleColumns(this.value);
            }
        });

        // İşlemi Kaydet butonu: Modalı aç
        const saveCurrentProcessBtn = document.getElementById('saveCurrentProcess');
        const saveProcessModal = new bootstrap.Modal(document.getElementById('saveProcessModal'));
        saveCurrentProcessBtn.addEventListener('click', function () {
            document.getElementById('processName').value = '';
            saveProcessModal.show();
        });

        // Modal içindeki Kaydet butonu
        document.getElementById('saveProcessButton').addEventListener('click', function () {
            const processName = document.getElementById('processName').value.trim();
            if (!processName) {
                alert('Lütfen işlem için bir isim girin.');
                return;
            }
            // Formdaki mevcut ayarları topla
            const fileInputMode = document.querySelector('input[name="fileInputMode"]:checked').value;
            const sheetName = sheetSelect.value;
            const createNewTable = createNewTableCheckbox.checked;
            const newTableName = newTableNameInput.value.trim();
            const tableName = tableSelect.value;
            const importMode = document.querySelector('input[name="importMode"]:checked')?.value;
            const mappings = [];
            document.querySelectorAll('#columnMappingBody tr').forEach(row => {
                const excelCol = row.cells[0].textContent;
                const oracleCol = createNewTableCheckbox.checked ?
                    row.cells[1].textContent :
                    row.cells[1].querySelector('select').value;
                const dataType = row.cells[2].querySelector('select').value;
                mappings.push({
                    excel_column: excelCol,
                    oracle_column: oracleCol,
                    oracle_type: dataType
                });
            });
            // API'ye kaydet
            fetch('/api/excel/save_process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    process_name: processName,
                    file_input_mode: fileInputMode,
                    sheet_name: sheetName,
                    create_new_table: createNewTable,
                    new_table_name: newTableName,
                    table_name: tableName,
                    import_mode: importMode,
                    column_mappings: mappings
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        saveProcessModal.hide();
                        showSuccess('İşlem başarıyla kaydedildi.');
                    } else {
                        alert('Kaydetme sırasında hata: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Kaydetme sırasında hata: ' + error);
                });
        });

        // Form gönderimi
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInputMode = document.querySelector('input[name="fileInputMode"]:checked').value;

            // Dosya bilgilerini ekle
            if (fileInputMode === 'select') {
                formData.append('file', fileInput.files[0]);
                formData.append('file_input_mode', 'select');
            } else {
                formData.append('file_path', filePathInput.value.trim());
                formData.append('file_input_mode', 'path');
            }

            // Sayfa ve tablo bilgilerini ekle
            formData.append('sheet_name', sheetSelect.value);
            formData.append('create_new_table', createNewTableCheckbox.checked);

            if (createNewTableCheckbox.checked) {
                formData.append('new_table_name', newTableNameInput.value.trim());
            } else {
                formData.append('table_name', tableSelect.value);
                formData.append('import_mode', document.querySelector('input[name="importMode"]:checked').value);
            }

            // Sütun eşleştirmelerini ekle
            const mappings = [];
            document.querySelectorAll('#columnMappingBody tr').forEach(row => {
                const excelCol = row.cells[0].textContent;
                const oracleCol = createNewTableCheckbox.checked ?
                    row.cells[1].textContent :
                    row.cells[1].querySelector('select').value;
                const dataType = row.cells[2].querySelector('select').value;

                mappings.push({
                    excel_column: excelCol,
                    oracle_column: oracleCol,
                    oracle_type: dataType
                });
            });
            formData.append('column_mappings', JSON.stringify(mappings));

            // İçe aktarma işlemini başlat
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            fetch('/api/excel/import', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess(data.message);
                        // Formu sıfırla
                        form.reset();
                        sheetSelect.innerHTML = '<option value="">Önce Excel dosyası seçin</option>';
                        sheetSelect.disabled = true;
                    } else {
                        showError(data.error);
                    }
                })
                .catch(error => {
                    showError('İçe aktarma sırasında hata oluştu: ' + error);
                })
                .finally(() => {
                    submitButton.disabled = false;
                });
        });

        // Başlangıç işlemleri
        loadOracleTables();
    });
</script>
{% endblock %}